---
created: 2024-07-06T00:35
updated: 2024-07-09T23:39
---
`useEffect( () => {} )`
To execute a piece of code **after** a component is rendered.

## Sending Http Requests

- `fetch()`
- `axios`

`npm i axios@1.3.4`

``` tsx
import axios from 'axios'

interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([])
  useEffect(()=>{
    axios.get<User[]>('http://jsonplaceholder.typicode.com/users')
      .then(res => setUsers(res.data));
  }, [])
  return <ul>
    {users.map(user => <li key={user.id}>{user.name}</li>)}
  </ul>
```

è¿™é‡Œ `UseState` éœ€è¦ç±»å‹æ ‡æ³¨ï¼Œå¦åˆ™ `users` åˆ—è¡¨çš„ç±»å‹æ— æ³•å¾—çŸ¥ï¼Œå…¶æ¬¡ `axios` è¿”å›çš„æ•°æ®ä¹Ÿéœ€è¦ç±»å‹æ ‡æ³¨ï¼Œå³ `axios.get<User[]>`

## Handling Errors

```tsx hl:8,14,19
interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");

  useEffect(() => {
    axios
      .get<User[]>("http://jsonplaceholder.typicode.com/xusers")
      .then((res) => setUsers(res.data))
      .catch((err) => setError(err.message));
  }, []);

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      <ul>
        {users.map((user) => (
          <li key={user.id}>{user.name}</li>
        ))}
      </ul>
    </>
  );
```

è§£å†³è·å–æ•°æ®æ—¶çš„å¼‚å¸¸æŠ¥é”™éœ€è¦é‡‡ç”¨ `.catch` æ–¹æ³•ï¼Œé€šè¿‡ `useState` ä½¿å…¶å›æ˜¾åˆ°é¡µé¢ä¸Šã€‚

## Async & Await (Optional)

`get` ä¼šè¿”å›ä¸€ä¸ª `promise`ï¼Œæœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œ`resolved` å’Œ `rejected`ã€‚
åœ¨ JavaScript ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª `promise`ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‰é¢æ”¾ `await` æ¥è·å¾—ç»“æœã€‚
ç”±äº React ä¸å…è®¸æˆ‘ä»¬ä¼ é€’ `async` å‡½æ•°ç»™ ` useEffect `ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `useEffect` å†…éƒ¨å†å®šä¹‰ä¸€ä¸ª `async` å‡½æ•°ã€‚

ä¸‡ä¸€è·å–æ•°æ®æŠ›å‡ºå¼‚å¸¸æŠ¥é”™äº†å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™éœ€è¦åœ¨ `async` å‡½æ•°å†…éƒ¨ä½¿ç”¨ ` try...catch ` æ¥è§£å†³ã€‚`const fetchUsers = async () => { try { const res = await ... } catch {err} }`

å…¶ä¸­æˆ‘ä»¬æ— æ³•åœ¨ `catch` çš„å½¢å‚åšç±»å‹æ ‡æ³¨ï¼Œåªèƒ½åœ¨å®å‚ä¸­ä½¿ç”¨ `as` å…³é”®å­—ï¼ˆç±»å‹æ–­è¨€ï¼‰`setError((err as AxiosError).message)`ã€‚React çš„è¿™ç§æ–¹æ³•å¹¶ä¸ä¼˜é›…ï¼ŒMosh æ›´åå‘äºä¸Šä¸€ä¸ªæ–¹æ³•ï¼Œå› ä¸ºä»£ç æ›´ä¸ºç¾è§‚å’Œç®€æ´ã€‚

```tsx fold title="aysnc&await"
import { useEffect, useState } from "react";
import axios, { AxiosError } from "axios";

interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");

  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const res = await axios.get<User[]>(
          "http://jsonplaceholder.typicode.com/xusers"
        );
        setUsers(res.data);
      } catch (err) {
        setError((err as AxiosError).message);
      }
    };
    fetchUsers();
  }, []);

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      <ul>
        {users.map((user) => (
          <li key={user.id}>{user.name}</li>
        ))}
      </ul>
    </>
  );
```

## Cancelling the Fetch Requests

`AbortController` æ˜¯ JavaScript ä¸­ä¸€ä¸ªç”¨äºæ§åˆ¶å’Œç®¡ç†å¼‚æ­¥æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ï¼‰çš„æ¥å£ã€‚å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ä¸å†éœ€è¦æ—¶å®‰å…¨åœ°å–æ¶ˆè¿™äº›æ“ä½œï¼Œä»¥èŠ‚çœèµ„æºå’Œé¿å…ä¸å¿…è¦çš„å¤„ç†ã€‚

```tsx hl:14,16-18,21,24
import { useEffect, useState } from "react";
import axios, { CanceledError } from "axios";

interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");

  useEffect(() => {
    const controller = new AbortController();
    axios
      .get<User[]>("http://jsonplaceholder.typicode.com/users", {
        signal: controller.signal,
      })
      .then((res) => setUsers(res.data))
      .catch((err) => {
        if (err instanceof CanceledError) return;
        setError(err.message);
      });
    return () => controller.abort();
  }, []);

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      <ul>
        {users.map((user) => (
          <li key={user.id}>{user.name}</li>
        ))}
      </ul>
    </>
  );
```

1. **åˆ›å»º AbortController å®ä¾‹**

   ```javascript
   const controller = new AbortController();
   ```

   `AbortController` æ˜¯ä¸€ä¸ªå†…ç½®çš„æµè§ˆå™¨ APIã€‚é€šè¿‡è°ƒç”¨å®ƒçš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ `AbortController` å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹åŒ…å«ä¸€ä¸ª `signal` å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥ä¸å¼‚æ­¥æ“ä½œè¿›è¡Œäº¤äº’ã€‚

2. **ä¼ é€’ä¿¡å·ç»™è¯·æ±‚**

   ```javascript
   axios.get<User[]>("http://jsonplaceholder.typicode.com/users", {
     signal: controller.signal,
   })
   ```

   åœ¨å‘èµ· `axios` è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å°† `controller.signal` ä½œä¸ºé…ç½®é¡¹çš„ä¸€éƒ¨åˆ†ä¼ é€’ç»™è¯·æ±‚ã€‚è¿™ä½¿å¾—è¯¥è¯·æ±‚ä¸ `AbortController` å…³è”èµ·æ¥ã€‚

3. **å–æ¶ˆè¯·æ±‚**

   ```javascript
   return () => controller.abort();
   ```

   `useEffect` çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œå½“ç»„ä»¶å¸è½½æˆ– `useEffect` å†æ¬¡è¿è¡Œæ—¶ï¼Œè¯¥å‡½æ•°å°†è¢«è°ƒç”¨ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è°ƒç”¨ `controller.abort()`ï¼Œè¿™ä¼šè§¦å‘ä¸ä¹‹å…³è”çš„è¯·æ±‚å–æ¶ˆã€‚

4. **å¤„ç†é”™è¯¯**

   ```javascript
   .catch((err) => {
     if (err instanceof CanceledError) return;
     setError(err.message);
   })
   ```

   å¦‚æœè¯·æ±‚è¢«å–æ¶ˆï¼Œ`axios` ä¼šæŠ›å‡ºä¸€ä¸ª `CanceledError`ã€‚æˆ‘ä»¬é€šè¿‡æ£€æŸ¥é”™è¯¯å®ä¾‹æ˜¯å¦ä¸º `CanceledError` æ¥å†³å®šæ˜¯å¦å¤„ç†è¯¥é”™è¯¯ã€‚å¦‚æœæ˜¯è¯·æ±‚å–æ¶ˆå¼•èµ·çš„é”™è¯¯ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›ï¼Œå¦åˆ™è®¾ç½®é”™è¯¯ä¿¡æ¯ã€‚

ç»“åˆç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼š

1. **æŒ‚è½½æ—¶**ï¼š

    - å½“ç»„ä»¶é¦–æ¬¡æŒ‚è½½æ—¶ï¼Œ`useEffect` å†…çš„ä»£ç ä¼šæ‰§è¡Œã€‚åˆ›å»ºä¸€ä¸ª `AbortController` å®ä¾‹ï¼Œå¹¶é€šè¿‡ `axios` å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚
2. **ç»„ä»¶æ›´æ–°**ï¼š

    - å› ä¸ºä¾èµ–æ•°ç»„æ˜¯ç©ºçš„ (`[]`)ï¼Œæ‰€ä»¥è¿™ä¸ª `useEffect` åªåœ¨ç»„ä»¶æŒ‚è½½å’Œå¸è½½æ—¶è¿è¡Œä¸€æ¬¡ï¼Œä¸ä¼šåœ¨ç»„ä»¶æ›´æ–°æ—¶å†æ¬¡è¿è¡Œã€‚
3. **å¸è½½æ—¶**ï¼š

    - å½“ç»„ä»¶å³å°†ä» DOM ä¸­ç§»é™¤æ—¶ï¼Œ`useEffect` è¿”å›çš„å‡½æ•°ï¼ˆæ¸…ç†å‡½æ•°ï¼‰ä¼šè¢«è°ƒç”¨ã€‚åœ¨è¿™ä¸ªæ¸…ç†å‡½æ•°ä¸­ï¼Œè°ƒç”¨ `controller.abort()` å–æ¶ˆè¿›è¡Œä¸­çš„ç½‘ç»œè¯·æ±‚ã€‚

å¦‚æœä¸æ·»åŠ  `if (err instanceof CanceledError) return;` è¿™è¡Œä»£ç ï¼Œå½“è¯·æ±‚è¢«å–æ¶ˆæ—¶ï¼Œä¼šæ•è·åˆ° `CanceledError`ï¼Œå¹¶è®¾ç½®é”™è¯¯æ¶ˆæ¯ã€‚è¿™ä¼šå¯¼è‡´å³ä½¿è¯·æ±‚æ•°æ®æˆåŠŸï¼Œç”¨æˆ·åˆ—è¡¨ä¹Ÿä¸ä¼šæ˜¾ç¤ºï¼Œå› ä¸ºä¹‹å‰çš„é”™è¯¯æ¶ˆæ¯ä»ç„¶å­˜åœ¨ã€‚

## Showing a Loading Indicator

åœ¨ React ä¸­ï¼Œ[`Promise`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)Â å®ä¾‹çš„Â **`finally()`**Â æ–¹æ³•ä¸èµ·ä½œç”¨ï¼Œå› æ­¤åªèƒ½åœ¨ `then()` å’Œ `catch()`  æ–¹æ³•å†…ç¼–å†™ä¸¤æ¬¡é‡å¤çš„ä»£ç ã€‚

é‚£ä¹ˆå¦‚ä½•æ˜¾ç¤ºåŠ è½½åŠ¨ç”»å‘¢ï¼Ÿè¿™é‡Œä½¿ç”¨äº† Bootstrap ä¸­ç±»ä¸º spinner-border çš„ divï¼Œé€šè¿‡ `isLoading` çŠ¶æ€æ§åˆ¶ã€‚

```tsx hl:12,17,25,30,38
import { useEffect, useState } from "react";
import axios, { CanceledError } from "axios";

interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");
  const [isLoading, setLoading] = useState(false);

  useEffect(() => {
    const controller = new AbortController();

    setLoading(true);

    axios
      .get<User[]>("http://jsonplaceholder.typicode.com/users", {
        signal: controller.signal,
      })
      .then((res) => {
        setUsers(res.data);
        setLoading(false);
      })
      .catch((err) => {
        if (err instanceof CanceledError) return;
        setError(err.message);
        setLoading(false);
      });
    return () => controller.abort();
  }, []);

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      {isLoading && <div className="spinner-border"></div>}
      <ul>
        {users.map ((user) => (
          <li key={user.id}>{user. name}</li>
        ))}
      </ul>
    </>
  );
}
```

## Adding Data

[[3-Managing Component State#Summary of Updating Objects and Array]]

ä¸¤ç§æ›´æ–°æ•°æ®çš„æ–¹å¼ï¼š

- Optimistic update
  1. Update the UI
  2. Call the server
- Pessimistic update
  1. Call the server
  2. Update the UI

Mosh åå‘ç¬¬ä¸€ç§ï¼Œå› æ­¤å‘¢ï¼Œæ“ä½œå¤±è´¥çš„æƒ…å†µä¸‹éœ€è¦è¿˜åŸåˆ—è¡¨ã€‚

1. **æ·»åŠ åˆ—è¡¨å’Œåˆ—è¡¨é¡¹çš„ç±»å**
    - ä¸ºåˆ—è¡¨æ·»åŠ  `list-group` ç±»åã€‚
    - ä¸ºåˆ—è¡¨é¡¹æ·»åŠ  `list-group-item` ç±»åã€‚

2. **æ·»åŠ æŒ‰é’®**
    - ä¸ºæŒ‰é’®æ·»åŠ  `btn btn-outline-danger` ç±»åã€‚

3. **ä½¿ç”¨ Flex å¸ƒå±€**
    - ä¸ºåˆ—è¡¨é¡¹æ·»åŠ  `d-flex` ç±»åï¼Œä»¥å¯ç”¨ Flex å¸ƒå±€ã€‚
    - æ·»åŠ  `justify-content-between` ç±»åï¼Œä½¿åˆ—è¡¨é¡¹å†…å®¹å·¦å³åˆ†å¸ƒã€‚

4. **æ·»åŠ æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶**
    - ç»™æŒ‰é’®æ·»åŠ  `onClick` äº‹ä»¶å¤„ç†ç¨‹åºï¼Œè§¦å‘ `deleteUser` å‡½æ•°ã€‚
    - `deleteUser` å‡½æ•°é¦–å…ˆä½¿ç”¨ `filter` è¿‡æ»¤ä¸ä¸å½“å‰ç”¨æˆ· ID ä¸€è‡´çš„ç”¨æˆ·ï¼ˆç­‰äºä»åˆ—è¡¨ä¸­åˆ é™¤äº†è¯¥ç”¨æˆ·ï¼‰ï¼Œç„¶åå‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨åˆ é™¤ç”¨æˆ·ã€‚
   - å¦‚æœè¯·æ±‚å‡ºé”™ï¼Œéœ€è¦è¿˜åŸåˆ—è¡¨å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚

```tsx hl:35-45,51,55,58-63
import { useEffect, useState } from "react";
import axios, { CanceledError } from "axios";

interface User {
  id: number;
  name: string;
}

function App () {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState ("");
  const [isLoading, setLoading] = useState (false);

  useEffect (() => {
    const controller = new AbortController ();

    setLoading (true);

    axios
      .get<User[]>(" http://jsonplaceholder.typicode.com/users" , {
        signal: controller. signal,
      })
      .then ((res) => {
        setUsers (res. data);
        setLoading (false);
      })
      .catch ((err) => {
        if (err instanceof CanceledError) return;
        setError (err. message);
        setLoading (false);
      });
    return () => controller.abort ();
  }, []);

  const deleteUser = (user: User) => {
    const originalUsers = [... users];
    setUsers (users.filter ((u) => u.id !== user. id));
    axios
      .delete (" http://jsonplaceholder.typicode.com/users/" + user. id)
      .catch ((err) => {
        setError (err. message);
        // ç”±äºæˆ‘ä»¬å…ˆæ“ä½œ UIï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œåº”è¯¥è¿˜åŸåˆ—è¡¨ã€‚
        setUsers (originalUsers);
      });
  };

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      {isLoading && <div className="spinner-border"></div>}
      <ul className="list-group">
        {users.map ((user) => (
          <li
            key={user. id}
            className="list-group-item d-flex justify-content-between"
          >
            {user. name}
            <button
              className="btn btn-outline-danger"
              onClick={() => deleteUser (user)}
            >
              Delete
            </button>
          </li>
        ))}
      </ul>
    </>
  );
```

## Creating Data

ç¬¬ 55 è¡Œ `{ data: savedUser }` ä¸­ `savedUser` ä¸æ˜¯ç±»å‹æ ‡æ³¨ï¼Œè€Œæ˜¯åˆ«åã€‚

```tsx hl:47-60,66-70
import { useEffect, useState } from "react";
import axios, { CanceledError } from "axios";

interface User {
  id: number;
  name: string;
}

function App () {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState ("");
  const [isLoading, setLoading] = useState (false);

  useEffect (() => {
    const controller = new AbortController ();

    setLoading (true);

    axios
      .get<User[]>(" http://jsonplaceholder.typicode.com/users" , {
        signal: controller. signal,
      })
      .then ((res) => {
        setUsers (res. data);
        setLoading (false);
      })
      .catch ((err) => {
        if (err instanceof CanceledError) return;
        setError (err. message);
        setLoading (false);
      });
    return () => controller.abort ();
  }, []);

  const deleteUser = (user: User) => {
    const originalUsers = [... users];
    setUsers (users.filter ((u) => u.id !== user. id));
    axios
      .delete (" http://jsonplaceholder.typicode.com/users/" + user. id)
      .catch ((err) => {
        setError (err. message);
        // ç”±äºæˆ‘ä»¬å…ˆæ“ä½œ UIï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œåº”è¯¥è¿˜åŸåˆ—è¡¨ã€‚
        setUsers (originalUsers);
      });
  };

  const addUser = () => {
    const newUser = { id: 0, name: "Mosh" };
    const originalUsers = [... users];
    setUsers ([newUser, ... users]);

    axios
      .post (" http://jsonplaceholder.typicode.com/users/" , newUser)
      // .then ((res) => setUsers ([res. data, ... users]));
      .then (({ data: savedUser }) => setUsers ([savedUser, ... users]))
      .catch ((err) => {
        setUsers (originalUsers);
        setError (err. message);
      });
  };

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      {isLoading && <div className="spinner-border"></div>}
      {! isLoading && (
        <button className="btn btn-primary mb-3" onClick={() => addUser ()}>
          Add
        </button>
      )}
      <ul className="list-group">
        {users.map ((user) => (
          <li
            key={user. id}
            className="list-group-item d-flex justify-content-between"
          >
            {user. name}
            <button
              className="btn btn-outline-danger"
              onClick={() => deleteUser (user)}
            >
              Delete
            </button>
          </li>
        ))}
      </ul>
    </>
  );
```

## Updating data

å¢åŠ äº†ä¸€ä¸ªæ›´æ–°æŒ‰é’®ï¼Œå…¶ä¸­ç±»å `mx-1` å¢åŠ å·¦å³è¾¹è·ã€‚ç”±äºä½¿ç”¨äº† flex å¸ƒå±€ï¼Œè€Œä¸”æ˜¯ ` space-between `ï¼Œæ‰€ä»¥éœ€è¦æŠŠä¸¤ä¸ªæŒ‰é’®æ·»åŠ åˆ°ä¸€ä¸ª ` div ` ä¸­ï¼Œã€‚

å¯¹äºæ›´æ–°æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `axios` çš„ ` put() ` æˆ–è€… ` patch() ` æ–¹æ³•ï¼Œè¿™å–å†³äºåç«¯çš„é€‰å‹ã€‚ç”±äºè¿™é‡Œåªæ›´æ–°äº†å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œæ‰€ä»¥ä½¿ç”¨äº† `patch()` æ–¹æ³•ã€‚

```tsx hl:62-76,94,95-100,107
import { useEffect, useState } from "react";
import axios, { CanceledError } from "axios";

interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");
  const [isLoading, setLoading] = useState(false);

  useEffect(() => {
    const controller = new AbortController();

    setLoading(true);

    axios
      .get<User[]>("http://jsonplaceholder.typicode.com/users", {
        signal: controller.signal,
      })
      .then((res) => {
        setUsers(res.data);
        setLoading(false);
      })
      .catch((err) => {
        if (err instanceof CanceledError) return;
        setError(err.message);
        setLoading(false);
      });
    return () => controller.abort();
  }, []);

  const deleteUser = (user: User) => {
    const originalUsers = [...users];
    setUsers(users.filter((u) => u.id !== user.id));
    axios
      .delete("http://jsonplaceholder.typicode.com/users/" + user.id)
      .catch((err) => {
        setError(err.message);
        // ç”±äºæˆ‘ä»¬å…ˆæ“ä½œ UIï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œåº”è¯¥è¿˜åŸåˆ—è¡¨ã€‚
        setUsers(originalUsers);
      });
  };

  const addUser = () => {
    const newUser = { id: 0, name: "Mosh" };
    const originalUsers = [...users];
    setUsers([newUser, ...users]);

    axios
      .post("http://jsonplaceholder.typicode.com/users/", newUser)
      // .then((res) => setUsers([res.data, ...users]));
      .then(({ data: savedUser }) => setUsers([savedUser, ...users]))
      .catch((err) => {
        setUsers(originalUsers);
        setError(err.message);
      });
  };

  const updateUser = (user: User) => {
    const updatedUser = { ...user, name: user.name + "!" };
    const originalUsers = [...users];

    setUsers(users.map((u) => (u.id === user.id ? updatedUser : u)));

    axios
      .patch("http://jsonplaceholder.typicode.com/users/" + user.id, {
        updatedUser,
      })
      .catch((err) => {
        setError(err.message);
        setUsers(originalUsers);
      });
  };

  return (
    <>
      {error && <p className="text-danger">{error}</p>}
      {isLoading && <div className="spinner-border"></div>}
      {!isLoading && (
        <button className="btn btn-primary mb-3" onClick={() => addUser()}>
          Add
        </button>
      )}
      <ul className="list-group">
        {users.map((user) => (
          <li
            key={user.id}
            className="list-group-item d-flex justify-content-between"
          >
            {user.name}
            <div>
              <button
                className="btn btn-outline-secondary mx-1"
                onClick={() => updateUser(user)}
              >
                Update
              </button>
              <button
                className="btn btn-outline-danger"
                onClick={() => deleteUser(user)}
              >
                Delete
              </button>
            </div>
          </li>
        ))}
      </ul>
    </>
  );
```

## Extracting a Reusable API Client (Hard)

``` hl:7,8
â””â”€â”€ ğŸ“src
    â””â”€â”€ App.tsx
    â””â”€â”€ ğŸ“assets
    â””â”€â”€ ğŸ“components
    â””â”€â”€ index.css
    â””â”€â”€ main.tsx
    â””â”€â”€ ğŸ“services
        â””â”€â”€ api-client.ts
    â””â”€â”€ vite-env.d.ts
```

### æ–°å»º `api-client.ts`

åœ¨ `src` æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ª  `services` æ–‡ä»¶å¤¹ï¼Œç”¨äºé…ç½® HTTP è¯·æ±‚ï¼Œå¹¶åœ¨æ–‡ä»¶å¤¹å†…æ–°å»ºä¸€ä¸ª `api-client.ts`  ç”¨äºå®šåˆ¶ `axios` å’Œ ` user-service.ts ` ç”¨äºå¤„ç†ç”¨æˆ·ç›¸å…³é€»è¾‘ã€‚

```ts title="api-client.ts"
import axios, { CanceledError } from "axios";

export default axios.create({
  baseURL: "http://jsonplaceholder.typicode.com",
  headers: {
    // 'api-key': 'xxx'
  },
});

export { CanceledError };
```

ä» `axios` æ¨¡å—å¯¼å…¥ ` axios ` å’Œ `CanceledError`ï¼Œè¿™æ · `main.tsx` ä¸éœ€è¦å†æ¬¡å¯¼å…¥ `axios`ã€‚ä½†æ˜¯éœ€è¦æŠŠ `axios` æ›¿æ¢ä¸º `apiClient`ã€‚

#### ä¿®æ”¹ `App.tsx`

```tsx title="App.tsx" hl:2,19,50,66
import { useEffect, useState } from "react";
import apiClient, { CanceledError } from "./services/api-client";

interface User {
  id: number;
  name: string;
}

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");
  const [isLoading, setLoading] = useState(false);

  useEffect(() => {
    const controller = new AbortController();

    setLoading(true);

    apiClient
      .get<User[]>("/users", {
        signal: controller.signal,
      })
      .then((res) => {
        setUsers(res.data);
        setLoading(false);
      })
      .catch((err) => {
        if (err instanceof CanceledError) return;
        setError(err.message);
        setLoading(false);
      });
    return () => controller.abort();
  }, []);

  const deleteUser = (user: User) => {
    const originalUsers = [...users];
    setUsers(users.filter((u) => u.id !== user.id));
    apiClient.delete("/users/" + user.id).catch((err) => {
      setError(err.message);
      // ç”±äºæˆ‘ä»¬å…ˆæ“ä½œ UIï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œåº”è¯¥è¿˜åŸåˆ—è¡¨ã€‚
      setUsers(originalUsers);
    });
  };

  const addUser = () => {
    const newUser = { id: 0, name: "Mosh" };
    const originalUsers = [...users];
    setUsers([newUser, ...users]);

    apiClient
      .post("/users", newUser)
      // .then((res) => setUsers([res.data, ...users]));
      .then(({ data: savedUser }) => setUsers([savedUser, ...users]))
      .catch((err) => {
        setUsers(originalUsers);
        setError(err.message);
      });
  };

  const updateUser = (user: User) => {
    const updatedUser = { ...user, name: user.name + "!" };
    const originalUsers = [...users];

    setUsers(users.map((u) => (u.id === user.id ? updatedUser : u)));

    apiClient
      .patch("http://jsonplaceholder.typicode.com/users/" + user.id, {
        updatedUser,
      })
      .catch((err) => {
        setError(err.message);
        setUsers(originalUsers);
      });
  };

  return (
    <>
      ......
    </>
  );
```

---

### æ–°å»º `user-service.ts`

åœ¨ `service` æ–‡ä»¶å¤¹å†…æ–°å»ºä¸€ä¸ª ` user-service.ts `  ç”¨äºå¤„ç†ç”¨æˆ·ç›¸å…³æœåŠ¡ï¼Œå¹¶å¯¼å…¥ `user-service.ts`ï¼ŒæŠŠ `App.tsx` å†…ä¸ç”¨æˆ·ç›¸å…³çš„ä»£ç æ•´åˆåˆ°å½“ä¸­ï¼Œä¸»è¦åŒ…æ‹¬ä¸€ä¸ªç”¨æˆ·æœåŠ¡ç±»ï¼ŒåŒ…å«äº†è·å–æ‰€æœ‰ç”¨æˆ·ã€åˆ é™¤ã€åˆ›å»ºå’Œæ›´æ–°ç”¨æˆ·çš„æ–¹æ³•ï¼Œæœ€åå¯¼å‡ºä¸€ä¸ªç±»çš„å®ä¾‹ã€‚

æ–¹æ³•æ˜¯ä¸€ä¸ª Promiseï¼Œéœ€è¦è¿”å›çŠ¶æ€ï¼Œå› æ­¤ä¸€å®šè¦ `return` ã€‚

```tsx title="user-service.ts"
import apiClient from "./api-client";

export interface User {
  id: number;
  name: string;
}

class UserService {
  getAllUser() {
    const controller = new AbortController();
    const request = apiClient.get<User[]>("/users", {
      signal: controller.signal,
    });
    return { request, cancel: () => controller.abort() };
  }

  deleteUser(id: number) {
    return apiClient.delete("/users/" + id);
  }

  createUser(newUser: User) {
    return apiClient.post("/users", newUser);
  }

  updateUser(user: User) {
    return apiClient.patch(
      "http://jsonplaceholder.typicode.com/users/" + user.id,
      user
    );
  }
}

export default new UserService();
```

#### ä¿®æ”¹ `App.tsx`

æŠŠ `user-service.ts` çš„ç±»å®ä¾‹å’Œç±»å‹æ¥å£å¯¼å…¥åˆ° `App.tsx` ä¸­ï¼ŒæŠŠ `apiClient` æ›¿æ¢ä¸º `userService` çš„å„ä¸ªæ–¹æ³•ã€‚

é»˜è®¤å¯¼å‡ºï¼ˆéšæ„ä¿®æ”¹å‘½åï¼‰å’Œå‘½åå¯¼å‡ºï¼ˆä¸èƒ½ä¿®æ”¹å‘½åï¼‰ï¼š` import userService, { User } from "./services/user-service"; `

ç”±äº ` user-service.ts ` å¯¼å…¥äº† ` apiClient `ï¼Œæ‰€ä»¥ ` App.jsx ` ä¸éœ€è¦å†é‡å¤å¯¼å…¥ã€‚

```tsx title="App.tsx" hl:2,3,12,13,23,30,42-43,58
import { useEffect, useState } from "react";
import { CanceledError } from "./services/api-client";
import userService, { User } from "./services/user-service";

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");
  const [isLoading, setLoading] = useState(false);

  useEffect(() => {
    setLoading(true);
    const { request, cancel } = userService.getAllUser();
    request
      .then((res) => {
        setUsers(res.data);
        setLoading(false);
      })
      .catch((err) => {
        if (err instanceof CanceledError) return;
        setError(err.message);
        setLoading(false);
      });
    return () => cancel();
  }, []);

  const deleteUser = (user: User) => {
    const originalUsers = [...users];
    setUsers(users.filter((u) => u.id !== user.id));

    userService.deleteUser(user.id).catch((err) => {
      setError(err.message);
      // ç”±äºæˆ‘ä»¬å…ˆæ“ä½œ UIï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œåº”è¯¥è¿˜åŸåˆ—è¡¨ã€‚
      setUsers(originalUsers);
    });
  };

  const addUser = () => {
    const newUser = { id: 0, name: "Mosh" };
    const originalUsers = [...users];
    setUsers([newUser, ...users]);

    userService
      .creatUser(newUser)
      // .then((res) => setUsers([res.data, ...users]));
      .then(({ data: savedUser }) => setUsers([savedUser, ...users]))
      .catch((err) => {
        setUsers(originalUsers);
        setError(err.message);
      });
  };

  const updateUser = (user: User) => {
    const updatedUser = { ...user, name: user.name + "!" };
    const originalUsers = [...users];

    setUsers(users.map((u) => (u.id === user.id ? updatedUser : u)));

    userService.updateUser(updatedUser).catch((err) => {
      setError(err.message);
      setUsers(originalUsers);
    });
  };

  return (
    <>
  .....
    </>
  );
}
```

---

### æ–°å»º `http-service.ts`

``` hl:9
â””â”€â”€ ğŸ“src
    â””â”€â”€ App.tsx
    â””â”€â”€ ğŸ“assets
    â””â”€â”€ ğŸ“components
    â””â”€â”€ index.css
    â””â”€â”€ main.tsx
    â””â”€â”€ ğŸ“services
        â””â”€â”€ api-client.ts
        â””â”€â”€ http-service.ts
        â””â”€â”€ user-service.ts
    â””â”€â”€ vite-env.d.ts
```

```tsx title="http-service.ts"
import apiClient from "./api-client";

interface Entity {
  id: number;
}

class HttpService {
  endpoint: string;
  constructor(endpoint: string) {
    this.endpoint = endpoint;
  }

  getAll<T>() {
    const controller = new AbortController();
    const request = apiClient.get<T[]>(this.endpoint, {
      signal: controller.signal,
    });
    return { request, cancel: () => controller.abort() };
  }

  delete(id: number) {
    return apiClient.delete(this.endpoint + "/" + id);
  }

  create<T>(entity: T) {
    return apiClient.post(this.endpoint, entity);
  }

  update<T extends Entity>(entity: T) {
    return apiClient.patch(
      "http://jsonplaceholder.typicode.com/users/" + entity.id,
      entity
    );
  }
}

const create = (endpoint: string) => new HttpService(endpoint);

export default create;
```

#### ä¿®æ”¹ `user-service.ts`

```tsx title="user-service.ts"
import create from "./http-service";

export interface User {
  id: number;
  name: string;
}

export default create("/users");
```

#### ä¿®æ”¹ `App.tsx`

ç”±äºåœ¨ `http-service.ts` ä¸­ `getAll()` æ–¹æ³•ä½¿ç”¨çš„æ˜¯é€šç”¨çš„ç±»å‹æ ‡æ³¨ï¼Œå› æ­¤ `userService.getAll();` éœ€è¦æ·»åŠ ç±»å‹æ ‡æ³¨ï¼Œå³ `userService.getAll<User>()`
ã€‚
> [!caution] æ­¤å¤„å¯¼å…¥ `user-service.ts` æ—¶é‡æ–°å‘½åä¸º `userService` äº†ã€‚ï¼ˆé»˜è®¤å¯¼å‡º `create("/user")`ï¼‰

```tsx title="App.tsx" hl:12,30,43,57
import { useEffect, useState } from "react";
import { CanceledError } from "./services/api-client";
import userService, { User } from "./services/user-service";

function App() {
  const [users, setUsers] = useState<User[]>([]);
  const [error, setError] = useState("");
  const [isLoading, setLoading] = useState(false);

  useEffect(() => {
    setLoading(true);
    const { request, cancel } = userService.getAll<User>();
    request
      .then((res) => {
        setUsers(res.data);
        setLoading(false);
      })
      .catch((err) => {
        if (err instanceof CanceledError) return;
        setError(err.message);
        setLoading(false);
      });
    return () => cancel();
  }, []);

  const deleteUser = (user: User) => {
    const originalUsers = [...users];
    setUsers(users.filter((u) => u.id !== user.id));

    userService.delete(user.id).catch((err) => {
      setError(err.message);
      // ç”±äºæˆ‘ä»¬å…ˆæ“ä½œ UIï¼Œå¦‚æœæ²¡æœ‰åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œåº”è¯¥è¿˜åŸåˆ—è¡¨ã€‚
      setUsers(originalUsers);
    });
  };

  const addUser = () => {
    const newUser = { id: 0, name: "Mosh" };
    const originalUsers = [...users];
    setUsers([newUser, ...users]);

    userService
      .create(newUser)
      .then(({ data: savedUser }) => setUsers([savedUser, ...users]))
      .catch((err) => {
        setUsers(originalUsers);
        setError(err.message);
      });
  };

  const updateUser = (user: User) => {
    const updatedUser = { ...user, name: user.name + "!" };
    const originalUsers = [...users];

    setUsers(users.map((u) => (u.id === user.id ? updatedUser : u)));

    userService.update(updatedUser).catch((err) => {
      setError(err.message);
      setUsers(originalUsers);
    });
  };

  return (
    <>
     ......
    </>
  );
}
```

## Creating a Custom Data Fetching Hook
